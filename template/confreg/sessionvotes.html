{%extends "confreg/confadmin_base.html" %}
{%load assets%}
{%load pgmarkdown%}
{%load dictutil%}
{%block title%}Vote for sessions{%endblock%}
{%block extrahead%}
{%asset "css" "fontawesome4" %}

<script type="text/javascript">
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('ajaxStatus').style.display = 'none';

  document.querySelectorAll('h3:has(label.dropdown-checkbox').forEach((h) => {
      h.addEventListener('click', (e) => {
          e.target.getElementsByTagName('input')[0].checked ^= 1;
      });
  });

  document.querySelectorAll('a.filteronly').forEach((a) => {
      a.addEventListener('click', (e) => {
          e.target.parentElement.querySelectorAll('input.filtercheck').forEach((c) => {
              c.checked = c.nextElementSibling == e.target;
          });
          e.target.parentElement.querySelector('input.filterall').checked = false;
          filter_sessions();
      });
  });

  document.querySelectorAll('input.filterall').forEach((cb) => {
      cb.addEventListener('change', (e) => {
          if (e.target.checked) {
              e.target.parentElement.querySelectorAll('input.filtercheck').forEach((c) => {
                  c.checked = true;
              });
          } else {
              e.target.checked = true;
          }
          filter_sessions();
      });
  });

  document.querySelectorAll('input.filtercheck').forEach((cb) => {
      cb.addEventListener('change', (e) => {
          filter_sessions();

          /* Update the "all" checkbox if needed */
          const filterall = e.target.parentElement.querySelector('input.filterall');
          if (filterall) {
              if (e.target.parentElement.querySelectorAll('input.filtercheck:not(:checked)').length) {
                  filterall.checked = false;
              } else {
                  filterall.checked = true;
              }
          }
      });
  });

  document.querySelectorAll('a.sortheader').forEach((a) => {
      a.addEventListener('click', (e) => {
          /* re-sort based on this column */
          let colnum = e.target.parentElement.cellIndex;
          const numsort = e.target.classList.contains('sortnumber');
          const table = document.getElementById('votetable');
          let sortdirection = 1;

          if (e.target.dataset.sorted) {
              sortdirection = e.target.dataset.sorted * -1;
          }

          Array.from(table.tBodies).sort((a, b) => {
              if (a.classList.contains('header'))
                  return -1;
              if (b.classList.contains('header'))
                  return 1;
              if (numsort) {
                  return (a.rows[0].cells[colnum].textContent - b.rows[0].cells[colnum].textContent) * sortdirection;
              }
              /* Else case-insensitive alpha sort */
              const ta = a.rows[0].cells[colnum].textContent.toUpperCase();
              const tb = b.rows[0].cells[colnum].textContent.toUpperCase();
              if (ta > tb)
                  return 1 * sortdirection;
              if (ta < tb)
                  return -1 * sortdirection;
              return 0;
          }).forEach(tb => table.appendChild(tb));

          table.querySelectorAll('a.sortheader').forEach((a) => {
              a.dataset.sorted = (a == e.target) ? sortdirection : '';
          });

          /* Need this to update the sequence number properly */
          filter_sessions();
      });
  });

  document.querySelectorAll('td.flt-votes select').forEach((sel) => {
      sel.addEventListener('change', (e) => {
          castVote(e.target.closest('tr.sessionrow').dataset.sid);
      });
  });
  document.querySelectorAll('td.fld-status').forEach((td) => {
      td.addEventListener('click', (e) => {
          changeStatus(e.target.closest('tr.sessionrow').dataset.sid);
      });
  });

  const dlgStatus = document.getElementById('dlgStatus');
  dlgStatus.querySelectorAll('button').forEach((b) => {
      b.addEventListener("click", (e) => {
          dlgStatus.close(e.target.dataset.statusid);
      });
  });
  dlgStatus.addEventListener("close", () => {
      if (dlgStatus.returnValue) {
          doUpdateStatus(dlgStatus.dataset.sid, dlgStatus.returnValue);
      }
  });

  const dlgComment = document.getElementById('dlgComment');
  dlgComment.querySelector('button').addEventListener('click', (e) => {
      dlgComment.close('save');
  });
  dlgComment.addEventListener("close", () => {
      if (dlgComment.returnValue == 'save') {
          doSaveComment(dlgComment.dataset.sid);
      }
  });
  document.getElementById('dlgCommentText').addEventListener('keyup', (e) => {
      if (e.keyCode == 13) {
          document.querySelector('dialog#dlgComment button').click();
      }
  });
  document.querySelectorAll('td.flt-cmt a.btn').forEach((a) => {
      a.addEventListener('click', (e) => {
          editComment(e.target.closest('tr.sessionrow').dataset.sid);
      });
  });

  filter_sessions();
});

function setAjaxStatus(str, iserror) {
    const el = document.getElementById('ajaxStatus');
    el.classList.add(iserror ? 'alert-danger' : 'alert-success');
    el.classList.remove(iserror ? 'alert-success' : 'alert-danger');
    el.innerText = str;
    el.style.display = 'block';
    setInterval(() => {
        el.style.display = 'none';
    }, 2000);
}

function filter_sessions() {
    /* Get all our statuses */
    const statuses = [...document.querySelectorAll('input[type=checkbox].filtercheck_status:checked')].map((cb) => parseInt(cb.id.replace('st_', '')));
    const tracks = [...document.querySelectorAll('input[type=checkbox].filtercheck_track:checked')].map((cb) => parseInt(cb.id.replace('t_', '')));
    const tags = [...document.querySelectorAll('input[type=checkbox].filtercheck_tag:checked')].map((cb) => parseInt(cb.id.replace('tg_', '')));
    const votedlimit = document.querySelector('input[type=checkbox]#vt_1:checked');

    let seq = 1;
    /* Recalculate visibility and sequence for all sessions */
    [...document.querySelectorAll('table#votetable tr.sessionrow')].forEach((row) => {
        /* Default is everything is visible, and then we remove */
        let visible = true;

        if (!statuses.includes(parseInt(row.dataset.status))) {
            visible = false;
        }

        if (!tracks.includes(parseInt(row.dataset.track))) {
            visible = false;
        }

        if (document.querySelector('input.filtercheck_tag')) {
            if (row.dataset.tags) {
                /* If *any* of the specified tags exist we're ok */
                let found = false;
                row.dataset.tags.split(",").map(t => parseInt(t)).forEach(t => {
                    if (tags.includes(t)) {
                        found = true;
                    }
                });
                if (!found) {
                    visible = false;
                }
            } else {
                if (!tags.includes(0)) {
                    visible = false;
                }
            }
        }

        if (votedlimit && row.querySelector('td[data-voted="yes"]')) {
            visible = false;
        }

        row.style.display = visible ? "table-row" : "none";
        document.getElementById('detailsrow_' + row.dataset.sid).style.display = visible ? "" : "none";

        if (visible) {
            row.querySelector('td').innerText = seq;
            seq += 1;
        } else {
            row.querySelector('td').innerText = '';
        }
    });
}

const valid_status_transitions = {{%for s, v in valid_status_transitions.items %}
   {{s}}: {
{%for k,t in v.items %}
      {{k}}: '{{t}}',{%endfor%}
   },{%endfor%}
};

function getFormData(obj) {
    let fd = new FormData();
    Object.entries(obj).forEach(([k, v]) => {
        fd.append(k, v);
    });
    return fd;
}

async function doUpdateStatus(id, statusval) {
    const targetRow = document.querySelector('tr.sessionrow[data-sid="' + id + '"]');
    const targetFld = targetRow.querySelector('td.fld-status');

    const response = await fetch('changestatus/', {
        'method': 'POST',
        'body': getFormData({
            'csrfmiddlewaretoken': '{{csrf_token}}',
            'sessionid': id,
            'newstatus': statusval,
        }),
        'credentials': 'same-origin',
    });
    if (response.ok) {
        const j = await response.json();
        targetRow.dataset.status = statusval;
        targetFld.getElementsByTagName('a')[0].text = j.newstatus;
        targetFld.style.backgroundColor = j.statechanged ? 'yellow' : 'white';
        document.getElementById('pendingNotificationsButton').style.display = j.pending ? 'inline-block': 'none';
        setAjaxStatus('Changed status to ' + j.newstatus, false);
    }
    else {
        if (response.status >= 400 && response.status < 500) {
            response.text().then(function (t) {
                setAjaxStatus('Error: ' + t);
            });
        } else {
            setAjaxStatus('Error: ' + response.statusText);
        }
    }
    return;
}

function changeStatus(id) {
   const currentstatus = document.querySelector('tr.sessionrow[data-sid="' + id + '"]').dataset.status;
   const dialog = document.getElementById('dlgStatus');
   dialog.dataset.sid = id;
   dialog.getElementsByTagName('h3')[0].innerText = "Change status [id: " + id + "]";
   const buttonDiv = dialog.getElementsByTagName('div')[0];
   buttonDiv.querySelectorAll('button').forEach((btn) => {
       btn.style.display = (btn.dataset.statusid in valid_status_transitions[currentstatus]) ? "inline-block": "none";
   });

   dialog.showModal();
}

async function castVote(sessionid) {
    const row = document.querySelector('tr.sessionrow[data-sid="' + sessionid + '"]');
    const td = row.querySelector('td.flt-votes');
    const s = td.getElementsByTagName('select')[0];
    const avgbox = row.querySelector('td.avgbox');

    const response = await fetch('vote/', {
        'method': 'POST',
        'body': getFormData({
            'csrfmiddlewaretoken': '{{csrf_token}}',
            'sessionid': sessionid,
            'vote': s.value,
        }),
        'credentials': 'same-origin',
    });
    if (response.ok) {
        td.dataset.voted = (s.value == 0)?"no":"yes";
        response.text().then(function (t) {
            avgbox.innerText = t;
        });
    } else {
        alert('AJAX call failed');
    }
}

async function doSaveComment(sessionid) {
    const dialog = document.getElementById('dlgComment');
    const row = document.querySelector('tr.sessionrow[data-sid="' + sessionid + '"]');
    const cspan = row.querySelector('li.owncomment span.comment');
    const txt = document.getElementById('dlgCommentText').value;

    if (txt != cspan.innerText) {
        const response = await fetch('comment/', {
            'method': 'POST',
            'body': getFormData({
                'csrfmiddlewaretoken': '{{csrf_token}}',
                'sessionid': sessionid,
                'comment': txt,
            }),
            'credentials': 'same-origin',
        });
        if (response.ok) {
            response.text().then(function (t) {
                cspan.innerText = t;
                row.querySelector('li.owncomment').style.display = (t == '') ? 'none' : 'block';
            });
        }
        else {
            alert('AJAX call failed');
        }
    }
}

function editComment(sessionid) {
    const dialog = document.getElementById('dlgComment');
    const row = document.querySelector('tr.sessionrow[data-sid="' + sessionid + '"]');
    const old = row.querySelector('li.owncomment span.comment').innerText;

    document.getElementById('dlgCommentText').value = old;
    dialog.dataset.sid = sessionid;

    dialog.showModal();
}
</script>
<style>
td.fld-status {
  cursor: pointer;
}
div.dlg {
  display: none;
}

/* Override bootstrap to make full screen */
.container {
width: 100%;
}

ul.comments {
    list-style-type: none;
    padding-left: 5px;
}
ul.comments span.username {
    font-weight: bold;
}

label.dropdown-checkbox input[type=checkbox] {
    display: none;
}
label.dropdown-checkbox input[type=checkbox] + span {
    display: inline-block;
    text-align: center;
}
label.dropdown-checkbox input[type=checkbox]:checked + span::after {
    content: "\f0d7";
    font-family: FontAwesome;
}
label.dropdown-checkbox input[type=checkbox]:not(:checked) + span::after {
    content: "\f0da";
    font-family: FontAwesome;
}
h3:has(label.dropdown-checkbox),
label.dropdown-checkbox {
    cursor: pointer;
}

td[data-voted="no"] {
    background-color: red;
}


tr.detailsrow td {
    text-align: center;
}
tr.detailsrow td div.detailscontent {
    max-width: 800px;
    text-align: left;
    display: inline-block;
}

tr.detailsrow  {
    display: none;
}
tr.headerrow:has(td label.dropdown-checkbox input[type=checkbox]:checked) + tr {
    display: table-row;
}

{% for fc in filtercolumns %}
tr.headerrow td.flt-{{fc.class}},
tr.headerrow th.flt-{{fc.class}} {
    display: none;
}
body:has(input#col_{{fc.class}}:checked) tr.headerrow td.flt-{{fc.class}},
body:has(input#col_{{fc.class}}:checked) tr.headerrow th.flt-{{fc.class}} {
   display: table-cell;
}
{% endfor%}

tr.headerrow {
    display: none;
}
tr.headerrow.tableheader {
    display: table-row;
}

a.filteronly {
    cursor: pointer;
}

a.sortheader {
    cursor: pointer;
}
a.sortheader::after {
    font-family: FontAwesome;
}
a.sortheader[data-sorted="1"]::after {
    content: " \f160";
}
a.sortheader[data-sorted="-1"]::after {
    content: " \f161";
}

dialog::backdrop {
    backdrop-filter: blur(4px);
}
</style>
{%endblock%}
{%block layoutblock%}
<h1>Vote for sessions - {{conference}}</h1>

<fieldset>
  <legend>Filter sessions</legend>
 <table role="presentation" border="0" width="100%" style="border-spacing: 2rem 0.3rem; border-collapse: separate;">
  <tr>
    <td style="width: 1px;">Track:</td>
    <td>
      {% for t in tracks %}<input type="checkbox" class="filtercheck filtercheck_track" id="t_{{t.id}}" checked> {{t.trackname}} <a class="filteronly">[only]</a> {% endfor %}
      <input type="checkbox" class="filterall" checked> All
    </td>
  </tr>
{%if conference.callforpaperstags %}
  <tr>
    <td>Tags:</td>
    <td>
      {% for t in tags %}<input type="checkbox" class="filtercheck filtercheck_tag" id="tg_{{t.id}}" checked> {{t.tag}} <a class="filteronly">[only]</a> {% endfor %}
      <input type="checkbox" class="filterall" checked> All
    </td>
  </tr>
{%endif%}
  <tr>
    <td>Statuses:</td>
    <td>
      {% for sid, s in status_choices %}<input type="checkbox" class="filtercheck filtercheck_status" id="st_{{sid}}" checked> {{s}} <a class="filteronly">[only]</a> {% endfor %}
      <input type="checkbox" class="filterall" checked> All
    </td>
  </tr>
{% if isvoter %}
  <tr>
    <td>Voted:</td>
    <td>
      <input type="checkbox" class="filtercheck filtercheck_voted" id="vt_1"> Show only sessions you have not voted for
    </td>
  </tr>
{% endif %}
  <tr>
    <td colspan="2">
  <a href="." class="btn btn-default">Reset</a>
{%if isadmin%}
  <a href="../sessionnotifyqueue/" id="pendingNotificationsButton" class="btn btn-warning"{%if not conference.pending_session_notifications%} style="display:none;"{%endif%}>View and send pending notifications</a>
{%endif%}
    </td>
  </tr>
 </table>
</fieldset>

<div id="ajaxStatus" class="alert alert-success" style="position: fixed; width: 100%;opacity: .8; text-align: center; font-weight: bold; font-size: 1.2em;">Loading submissions</div>

{%if not hasvoters%}
<div class="alert alert-warning">There are no talkvoters configured on this conference! List of talks will be empty!</div>
{%endif%}

<fieldset>
  <legend>Vote on sessions</legend>
<p><b>Scoring method:</b> {{ scoring_method }}</p>
<p><b>Columns:</b> {% for fc in filtercolumns %}<input type="checkbox" id="col_{{fc.class}}"{%if fc.default%} checked{%endif%}> {{fc.title}} {% endfor %}

<table id="votetable" class="table table-bordered table-condensed">
 <tbody class="header">
 <tr class="headerrow tableheader">
  <th class="flt-seq" style="width: 1%">Seq</th>
  <th class="flt-id" style="width: 1%"><a class="sortheader sortnumber">Id</a></th>
  <th class="col-md-6"><a class="sortheader">Session</a></th>
  <th class="flt-spk"><a class="sortheader">Speakers</a></th>
  <th class="flt-comp"><a class="sortheader">Companies</a></th>
  <th class="flt-trk"><a class="sortheader">Track</a></th>
  <th class="flt-tag"><a class="sortheader">Tags</a></th>
  <th><a class="sortheader">Status</a></th>

  {%for u in users%}
  {% if conference.showvotes or isadmin or u == user.username and isvoter %}
  <th class="flt-votes">{%if u == user.username%}{{u}}{%else%}<a class="sortheader sortnumber">{{u}}</a>{%endif%}</th>
  {% endif %}
  {%endfor%}

  {% if conference.showvotes or isadmin %}
  <th class="flt-avg"><a class="sortheader sortnumber">Average</a></th>
  {% endif %}

  <th class="flt-cmt">Comments</th>
 </tr>
 </tbody>
{%for s in sessionvotes%}
 <tbody>
 <tr class="headerrow sessionrow" data-sid="{{s.id}}" data-status="{{s.statusid}}" data-track="{{s.trackid|default:"0"}}"{% if conference.callforpaperstags %} data-tags="{{s.tags|join_dictkeys:"id,,"}}"{% endif %}>
   <td class="flt-seq text-center">{{forloop.counter}}</td>
   <td class="flt-id">{{s.id}}</td>
   <td>
     <h3><label class="dropdown-checkbox"><input type="checkbox" data-sid="{{s.id}}"><span></span></label> {{s.title}}</h3>
   </td>
   <td class="flt-spk">{{s.speakerdata|join_dictkeys:"fullname"}}</td>
   <td class="flt-comp">{{s.speakerdata|join_dictkeys:"company"}}</td>
   <td class="flt-trk">{{s.trackname|default:""}}</td>
   <td class="flt-tag">{{s.tags|join_dictkeys:"tag"}}</td>
   {%if isadmin%}
   <td{%if s.speakerdata and not s.statusid == s.laststatusid %} bgcolor="yellow"{%endif%} class="fld-status"><a href="#" onclick="return false;">{{s.status}}</a></td>
{%else%}
   <td>{{s.status}}</td>
{%endif%}

  {%for u in users%}
   {%if u == user.username%}
      <td class="flt-votes" data-voted="{%if s.votes|dictlookup:u is None %}no{%else%}yes{%endif%}">
        <select>
          {%for val, opt in options%}
            <option value="{{val}}"{%if val == s.votes|dictlookup:u|default_if_none:0%} SELECTED{%endif%}>{{opt}}</option>
          {%endfor%}
        </select>
      </td>
    {%else%}
      {% if conference.showvotes or isadmin %}
        <td class="flt-votes">{%if s.votes|dictlookup:u == -1%}Abstain{%else%}{{s.votes|dictlookup:u|default_if_none:''}}{%endif%}</td>
      {%endif%}
    {%endif%}
  {%endfor%}

  {% if conference.showvotes or isadmin %}
  <td class="avgbox flt-avg">{{s.avg|default_if_none:''}}</td>
  {% endif %}

   <td class="flt-cmt">
{%if isvoter%}
     <div style="margin-right: 0.5em; float:left;">
       <a class="btn btn-default btn-xs"><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></a>
     </div>
{%endif%}
     <div style="display:inline-block;">
{%for u, c in s.comments.items%}
<ul class="comments">
  <li{%if u == user.username%} class="owncomment" {%if c == ""%} style="display:none"{%endif%}{%endif%}><span class="username">{{u}}:</span> <span class="comment">{{c}}</span></li>
</ul>
{%endfor%}
     </div>
   </td>
 </tr>
 <tr class="detailsrow" data-sid="{{s.id}}" id="detailsrow_{{s.id}}">
   <td colspan="{{colcount}}">
     <div class="detailscontent">
{%if isadmin%}
       <a class="btn btn-default" style="float:right" href="/events/admin/{{conference.urlname}}/sessions/{{s.id}}/" target="_blank">Edit submission</a>
{%endif%}
       <div><strong>Speakers:</strong> {%for sp in s.speakerdata%}{{sp.fullname}}{%if sp.company%} ({{sp.company}}){%endif%}{%if not forloop.last%}, {%endif%}{%endfor%}</div>
       <div><strong>Track:</strong> {{s.trackname|default:""}}</div>
{%if conference.callforpaperstags%}
       <div><strong>Tags:</strong> {%for t in s.tags%}<span class="label label-primary">{{t.tag}}</span> {%endfor%}</div>
{%endif%}
{%if conference.callforpapersrecording%}
       <div><strong>Recording consent:</strong> {{s.recordingconsent | yesno:"Yes,No" }}</div>
{%endif%}	 <br/>
{{s.abstract|markdown}}
{%if s.submissionnote%}
	     <hr/>
	     <h3>Submission notes</h3>
       <p>
{{s.submissionnote}}
	     </p>
{%endif%}
{%if s.internalnote%}
	     <hr/>
	     <h3>Internal notes</h3>
       <p>
{{s.internalnote}}
	     </p>
{%endif%}
	     <hr/>
{%if s.speakerdata %}
	     <h3>Speaker profile</h3>
{%for sp in s.speakerdata %}
	     <h4>{{sp.fullname}}{%if sp.company%} ({{sp.company}}){%endif%} [speaker id: {{sp.id}}]</h4>
	     {{sp.abstract|markdown}}
{%endfor%}
{%endif%}
    </div>
   </td>
 </tr>
</tbody>
{%endfor%}
</table>

</fieldset>

<dialog id="dlgStatus">
  <h3>Change status</h3>
  <p>Change status to:</p>
  <div>
{%for statusid, status in status_choices %}
   <button class="btn" data-statusid="{{statusid}}">{{status}}</button>
{%endfor%}
  </div>
  <button class="btn">Cancel</button>
</dialog>

<dialog id="dlgComment">
  <h3>Edit comment</h3>
  <input type="text" id="dlgCommentText" style="width: 300px;">
  <button class="btn">Save</button>
</dialog>

{%endblock%}
